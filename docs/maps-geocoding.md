# Реализация картографии, геокодирования и автоподбора адреса в SpainEstates

## Общее описание

В проекте SpainEstates реализована полнофункциональная система работы с географическими данными, включающая:

1. **Интерактивные карты** на базе Leaflet для отображения и выбора местоположения объектов
2. **Геокодирование** для преобразования координат в адреса и наоборот
3. **Автозаполнение адресов** с поддержкой поиска по улицам и номерам домов
4. **Автоматическое масштабирование** для оптимального отображения выбранных локаций

## Компоненты системы

### 1. AddressAutocomplete

Компонент для автоматического поиска и заполнения адресов с поддержкой номеров домов.

**Путь**: `app/admin/properties/create/components/address-autocomplete/index.tsx`

**Основные возможности**:
- Поиск адресов с использованием OpenStreetMap Nominatim API
- Извлечение и сохранение номера дома из поискового запроса
- Форматирование полных адресов с добавлением номера дома
- Отображение подсказок с найденными адресами
- Визуальное представление найденного номера дома
- Возможность очистки введенного адреса

**Пример использования**:
```tsx
<AddressAutocomplete 
  onSelectAddress={(address, lat, lng) => {
    // Обработка выбранного адреса
  }}
  placeholder="Введите адрес объекта недвижимости"
  initialValue={existingAddress || ''}
/>
```

### 2. LeafletMap

Интерактивная карта на базе библиотеки Leaflet для отображения и выбора местоположения.

**Путь**: `app/admin/properties/create/components/map/LeafletMap.tsx`

**Основные возможности**:
- Отображение интерактивной карты OpenStreetMap
- Отображение маркера с возможностью перетаскивания
- Обратное геокодирование при выборе точки на карте
- Автоматическое масштабирование при выборе адреса
- Адаптация карты под различные устройства
- Принудительная установка оптимального зума при выборе локации

**Дополнительные компоненты**:
- `MapController` - управление картой и обновление позиции
- `ForcedZoomController` - принудительная установка масштаба для лучшей видимости

**Пример использования**:
```tsx
<LeafletMap 
  position={[42.123, -3.456]}
  setPosition={handlePositionChange}
  initialZoom={15}
  onAddressFound={handleAddressFound}
/>
```

### 3. LocationStep

Интеграционный компонент для формы создания/редактирования объекта недвижимости.

**Путь**: `app/admin/properties/create/components/LocationStep.tsx`

**Основные возможности**:
- Объединение компонентов AddressAutocomplete и LeafletMap
- Управление состоянием формы с использованием react-hook-form
- Обработка геокодированных данных и обновление полей формы
- Автоматическое определение региона и города на основе выбранных координат
- Синхронизация между вводом адреса и позицией на карте
- Управление детальным масштабированием при выборе адреса

## Алгоритмы и процессы

### Геокодирование

Для преобразования координат в адреса и обратно используется сервис **OpenStreetMap Nominatim**:

1. **Прямое геокодирование** (адрес → координаты):
   ```
   https://nominatim.openstreetmap.org/search?format=json&q=АДРЕС&limit=5&addressdetails=1&countrycodes=es
   ```

2. **Обратное геокодирование** (координаты → адрес):
   ```
   https://nominatim.openstreetmap.org/reverse?format=json&lat=ШИРОТА&lon=ДОЛГОТА&addressdetails=1&accept-language=ru
   ```

### Обработка номеров домов

Реализован специальный алгоритм для обработки номеров домов:

1. Извлечение номера дома из строки поиска с помощью регулярного выражения:
   ```javascript
   const match = query.match(/(\d+\s*[a-zA-Z\-]?)(?:\s|$)/);
   ```

2. Добавление номера дома к адресу, если API не предоставил его автоматически:
   ```javascript
   if (extractedHouseNumber && suggestion.address?.road) {
     address = address.replace(roadName, `${roadName}, ${extractedHouseNumber}`);
   }
   ```

3. Визуальное отображение найденного номера дома для пользователя

### Масштабирование карты

Для оптимального отображения выбранного адреса реализован многоуровневый механизм масштабирования:

1. **ForcedZoomController** - принудительная установка зума при выборе адреса
2. Отложенное масштабирование через setTimeout для гарантированного применения
3. Использование флагов состояния для определения необходимости детального отображения
4. Автоматический переход к масштабу 18 для отображения уровня улиц и домов

## Интеграция компонентов

Компоненты системы тесно интегрированы между собой:

1. При выборе адреса в **AddressAutocomplete**:
   - Обновляются поля формы (адрес, координаты)
   - Устанавливается маркер на карте
   - Активируется детальный зум для отображения

2. При клике на карте в **LeafletMap**:
   - Выполняется обратное геокодирование
   - Обновляется адрес в форме
   - Определяются регион и город

3. При перетаскивании маркера:
   - Обновляются координаты
   - Выполняется обратное геокодирование
   - Активируется принудительный зум для лучшей видимости

## Особенности и ограничения

1. **API Nominatim**:
   - Имеет ограничение на количество запросов (1 запрос в секунду)
   - Не всегда возвращает полную информацию о номерах домов
   - Требует правильного заголовка User-Agent

2. **Обработка номеров домов**:
   - Требует дополнительной логики для извлечения и добавления к адресу
   - Не всегда точно определяет координаты конкретного дома

3. **Масштабирование карты**:
   - Иногда требует дополнительных механизмов для гарантированного применения
   - Зависит от правильной последовательности обновления состояний

## Рекомендации по улучшению

1. Добавить кэширование результатов геокодирования для уменьшения количества запросов
2. Реализовать проверку границ регионов для более точного определения
3. Добавить поддержку отображения POI (Points of Interest) рядом с выбранным местоположением
4. Реализовать поддержку поиска не только по адресам, но и по ключевым словам (школы, пляжи и т.д.)
5. Добавить отображение расстояний до ключевых объектов (море, аэропорт, центр города)

## Примеры использования

### Создание объекта недвижимости

При создании объекта недвижимости пользователь может:

1. Ввести адрес в поле автозаполнения и выбрать из предложенных вариантов
2. Указать конкретный номер дома, который будет корректно обработан
3. Выбрать точку на карте, которая автоматически определит адрес
4. Перетащить маркер для уточнения позиции
5. Увидеть координаты выбранного местоположения

### Тестовая страница

Для проверки функциональности автозаполнения адресов создана специальная тестовая страница:

- Путь: `/test`
- Компонент: `app/test/page.tsx`
- Возможности:
  - Тестирование API Nominatim
  - Проверка поиска по готовым примерам адресов
  - Отображение логов запросов
  - Отображение найденных координат 